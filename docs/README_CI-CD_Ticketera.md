# Ticketera ¬∑ CI/CD & Workflows (Monorepo)
> **Objetivo:** documentar c√≥mo funciona el pipeline de integraci√≥n y release del monorepo `ticketera` (frontend en React + backend en Java/Spring), qu√© hace cada workflow, c√≥mo versionamos con semantic-release, c√≥mo publicamos im√°genes en GHCR y c√≥mo verificar todo con un smoke test.

---

## üì¶ Estructura del repositorio

```
/ticketera
  /frontend                  # React
  /backend                   # Java / Spring
    /gateway
    /auth-service
    /event-service
    /ticket-service
    /payment-service
    /notification-service
.github/workflows/           # Workflows de GitHub Actions
commitlint.config.cjs        # Reglas de Conventional Commits
CODEOWNERS                   # Responsables por carpeta
PULL_REQUEST_TEMPLATE.md     # Template de PR
```

---

## üåø Estrategia de ramas

- `main` ‚Üí rama estable (releases de producci√≥n). Llega **solo** por PR.
- `develop` ‚Üí integraci√≥n del sprint (**pre‚Äëreleases**).
- `feature/*` ‚Üí trabajo diario de cada dev.
- `hotfix/*` ‚Üí arreglos urgentes que salen a `main` y se backmergean a `develop`.

> No usamos `release/*` (con 2 devs es fricci√≥n extra).

---

## üßæ Resumen de Workflows

| Archivo | ¬øCu√°ndo corre? | ¬øQu√© valida / produce? |
|---|---|---|
| `ci-pr.yml` | En cada **PR** a `develop` o `main` | Detecta qu√© carpetas cambiaron, **build + test** del frontend y **verify** de cada microservicio Java tocado. |
| `docker-ci-pr.yml` | En cada **PR** a `develop` o `main` | **Construye im√°genes Docker** solo de lo que cambi√≥ (no publica). |
| `commitlint.yml` | Al abrir/editar/sincronizar **PR** | Verifica **Conventional Commits** en el **t√≠tulo** y en los **commits**. |
| `release-develop.yml` | Push a **`develop`** | Corta **pre‚Äëreleases** (`-next`) por m√≥dulo (tags + changelog) y **publica im√°genes** etiquetadas para testing en **GHCR**. |
| `release-main.yml` | Push a **`main`** | Corta **releases estables** (tags + changelog) y **publica im√°genes** con `vX.Y.Z` y `latest` en **GHCR**. |
| `guard-branches.yml` | Push directo a `main` o `develop` | **Falla** si el push no viene de bot/release; recordatorio de usar PR. |

---

## üß© Detalle de cada workflow

### 1) `ci-pr.yml` ‚Äî CI en Pull Requests
- **Trigger:** PR a `develop` o `main`.
- **Pasos clave:**
  1. `dorny/paths-filter` marca flags por carpeta (frontend, gateway, auth, ‚Ä¶) para ejecutar **solo** lo que cambi√≥.
  2. **Frontend (React):** Node.js v20.x + cache npm ‚Üí `npm ci` ‚Üí `npm run lint` ‚Üí `npm test` (si existe) ‚Üí `npm run build`.
  3. **Backend (Java/Spring):** JDK 17 (Temurin) + cache Maven ‚Üí `mvn verify` (o `./mvnw verify`) **por servicio tocado**.
- **Objetivo:** el PR queda validado si el c√≥digo compila, pasa tests y no rompe lo que fue modificado.

### 2) `docker-ci-pr.yml` ‚Äî Build Docker en PR
- **Trigger:** PR a `develop` o `main`.
- **Pasos clave:**
  - Misma detecci√≥n por carpetas/Dockerfile.
  - `docker/setup-buildx-action` + `docker/build-push-action@v6` para **construir** im√°genes (sin push) con **cache de capas** (m√°s r√°pido).
- **Objetivo:** atrapar errores de Dockerfile/dep. **antes** de mergear.

### 3) `commitlint.yml` ‚Äî Convencional en PR
- **Trigger:** abrir/editar/sincronizar PR.
- **Pasos:** instala commitlint en el runner y valida **t√≠tulo** y **commits** del PR con `@commitlint/config-conventional` (regla `subject-case` relajada).
- **Objetivo:** mensajes consistentes para que semantic‚Äërelease infiera **bump** (patch/minor/major).

### 4) `release-develop.yml` ‚Äî Pre‚Äëreleases en `develop`
- **Trigger:** push a `develop` (normalmente al mergear PR).
- **Pasos (por m√≥dulo/carpeta):**
  - **semantic‚Äërelease** con `branches: [{ name: 'develop', prerelease: 'next' }, 'main']`.
  - Genera **tag prerelease** (por m√≥dulo): p. ej. `gateway-v1.2.0-next.3` y actualiza `CHANGELOG.md`.
  - Construye y **publica** im√°genes a **GHCR** con etiqueta de canal: `develop-next-<sha>` (listas para QA).
- **Objetivo:** tener artefactos listos para testing durante el sprint.

### 5) `release-main.yml` ‚Äî Releases estables en `main`
- **Trigger:** push a `main` (merge desde `develop` o hotfix).
- **Pasos (por m√≥dulo/carpeta):**
  - **semantic‚Äërelease** corta versi√≥n **estable** (sin `-next`), actualiza changelog y crea `GitHub Release`.
  - Construye y **publica** im√°genes a GHCR con **dos tags**: `vX.Y.Z` y `latest`.
- **Objetivo:** cierre prolijo del sprint y artefactos de producci√≥n versionados.

### 6) `guard-branches.yml` ‚Äî Guardia anti push directo
- **Trigger:** push directo a `main`/`develop`.
- **Comporta:** permite **solo** commits de release o bots; cualquier otro **falla el check** con aviso ‚ÄúUs√° PR‚Äù.
- **Objetivo:** disciplina de PR sin necesitar reglas de protecci√≥n.

---

## üè∑Ô∏è Versionado por m√≥dulo con semantic‚Äërelease

Cada carpeta relevante tiene su **`release.config.cjs`**:
- **Frontend** ‚Üí `tagFormat: "frontend-v${version}"`.
- **Gateway** ‚Üí `tagFormat: "gateway-v${version}"`.
- **Auth** ‚Üí `tagFormat: "auth-service-v${version}"`.
- ‚Ä¶y as√≠ para cada microservicio.

**Plugins t√≠picos:**
- `@semantic-release/commit-analyzer` + `@semantic-release/release-notes-generator`
- `@semantic-release/changelog` (escribe/actualiza `CHANGELOG.md`)
- `@semantic-release/git` (commitea changelog, y en frontend tambi√©n `package.json` si corresponde)
- `@semantic-release/github` (crea el Release)
- **Frontend solo:** `@semantic-release/npm` con `{ npmPublish: false }` (no publica a npm; mantiene versi√≥n en `package.json`).

> **Nota:** en servicios Java no hay `package.json`, se usa changelog + tags + release de GitHub.

---

## üê≥ Im√°genes en GHCR (GitHub Container Registry)

- Registry: `ghcr.io/<OWNER>/‚Ä¶`
- Nombres propuestos:
  - `ghcr.io/<OWNER>/ticketera-frontend`
  - `ghcr.io/<OWNER>/ticketera-gateway`
  - `ghcr.io/<OWNER>/ticketera-auth-service`
  - `ghcr.io/<OWNER>/ticketera-event-service`
  - `ghcr.io/<OWNER>/ticketera-ticket-service`
  - `ghcr.io/<OWNER>/ticketera-payment-service`
  - `ghcr.io/<OWNER>/ticketera-notification-service`

**Tags que generamos:**
- En `develop`: `develop-next-<sha>` (r√°pido de identificar para QA).
- En `main`: `vX.Y.Z` y `latest`.

> El login a GHCR usa `GITHUB_TOKEN` del runner; no hay que crear secretos.

---

## ‚öôÔ∏è Archivos de configuraci√≥n (repo ra√≠z)

### `commitlint.config.cjs`
```js
export default {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'subject-case': [0, 'never'], // flexible con may√∫sculas/casos
  },
};
```

### `CODEOWNERS` (ejemplo)
```
*                                        @usuario1 @usuario2
/ticketera/frontend/                     @usuario1
/ticketera/backend/auth-service/         @usuario2
/ticketera/backend/event-service/        @usuario2
/ticketera/backend/ticket-service/       @usuario1
/ticketera/backend/payment-service/      @usuario1
/ticketera/backend/notification-service/ @usuario2
/ticketera/backend/gateway/              @usuario1
```

### `PULL_REQUEST_TEMPLATE.md`
```md
## Resumen
- ¬øQu√© cambia y por qu√©?

## Checklist
- [ ] Commits con Conventional Commits
- [ ] CI verde (lint/test/build)
- [ ] Changelog (lo genera semantic-release)
```

---

## üß± Docker: pautas r√°pidas

- **`.dockerignore`** por m√≥dulo (evitar copiar `.git`, `node_modules`, `target`, etc.).
- **Multi‚Äëstage**:
  - Frontend: build en `node:20` ‚Üí servir con `nginx:alpine`.
  - Spring: build en `maven:3.9-eclipse-temurin-17` ‚Üí run en `eclipse-temurin:17-jre`.
- **Labels OCI** y `--build-arg VCS_REF=$GITHUB_SHA` opcional para trazabilidad.
- **Cache de capas** activo en los workflows (r√°pidos).

---

## üß∞ Dependencias & secretos necesarios

- **Commitlint** y **semantic‚Äërelease** se instalan en los runners con `npx`. No necesit√°s preinstalar nada.
- **GHCR** usa el `GITHUB_TOKEN` interno (sin secretos extra).
- Si m√°s adelante us√°s otro registry, agreg√°s `DOCKER_USERNAME/DOCKER_PASSWORD` y cambi√°s `docker/login-action`.

---

## üßØ Problemas comunes (y soluci√≥n r√°pida)

- **Falla `commitlint`** ‚Üí correg√≠ el t√≠tulo/commits al formato `type(scope): subject` (p. ej. `feat(auth): login con JWT`).
- **Falla `ci-pr` en Java** ‚Üí corr√© local `mvn -B verify` en ese servicio; faltan tests o dependencia.
- **Falla `docker-ci-pr`** ‚Üí revis√° el `Dockerfile` y `.dockerignore` de ese m√≥dulo.
- **No aparece la imagen en GHCR** ‚Üí verific√° pesta√±a **Packages** del repo y que corri√≥ `release-*` (develop/main).
- **No se generan pre‚Äëreleases** ‚Üí asegurate de mergear a `develop` y que haya **commits convencionales**.

---

## ‚úÖ Smoke Test (paso a paso)

> Objetivo: verificar que todo funciona end‚Äëto‚Äëend.

### Pre‚Äëchequeo
1. Confirm√° que est√°n estos archivos en el repo:
   - `.github/workflows/ci-pr.yml`
   - `.github/workflows/docker-ci-pr.yml`
   - `.github/workflows/commitlint.yml`
   - `.github/workflows/release-develop.yml`
   - `.github/workflows/release-main.yml`
   - `.github/workflows/guard-branches.yml`
   - `commitlint.config.cjs`
   - `release.config.cjs` en `ticketera/frontend` **y** en cada `ticketera/backend/*`
2. Revis√° que haya **Dockerfile** en `ticketera/frontend` y en cada microservicio.
3. Acordate de los **nombres de im√°genes** (GHCR) que usar√°n los workflows.

### Paso 1 ‚Äî PR de prueba a `develop`
```bash
git checkout -b feature/smoke-test
# modificar un archivo simple en ticketera/frontend o en 1 microservicio
git add .
git commit -m "feat(frontend): prueba de pipeline (smoke test)"
git push -u origin feature/smoke-test
# Abrir PR contra develop
```
**Esperado en PR:**
- ‚úÖ `ci-pr` (solo para lo modificado)
- ‚úÖ `docker-ci-pr` (construye imagen del m√≥dulo modificado)
- ‚úÖ `commitlint`

### Paso 2 ‚Äî Merge a `develop`
- Al mergear, corre `release-develop`:
  - Ver√°s **pre‚Äërelease** en **Releases** con tag por m√≥dulo (`*-vX.Y.Z-next.N`).
  - En **Packages** del repo aparecer√° la **imagen** del m√≥dulo con tag `develop-next-<sha>`.

### Paso 3 ‚Äî PR `develop` ‚Üí `main` (cierre)
- Abrir PR y mergear.
- `release-main` debe:
  - Crear **Release estable** por m√≥dulo (`*-vX.Y.Z`).
  - Publicar im√°genes en GHCR con tags `vX.Y.Z` y `latest`.
- Verificarlo en **Releases** y **Packages**.

### Paso 4 ‚Äî Anti‚Äëpatr√≥n (opcional)
- Intentar un **push directo** a `develop`:
  - El workflow `guard-branches` debe **fallar** con mensaje ‚ÄúUs√° PR‚Äù.

### Paso 5 ‚Äî Romper adrede (opcional)
- Modificar un `Dockerfile` con un error y levantar PR:
  - `docker-ci-pr` debe **fallar** (demuestra que la guardia funciona).
- Hacer un commit con mal formato (ej. `Update`):
  - `commitlint` debe **fallar** hasta que lo corrijas.

---

## üôã FAQ r√°pida

- **¬øQu√© es GHCR?** GitHub Container Registry: el ‚Äúdep√≥sito‚Äù de im√°genes Docker que integra con GitHub.
- **¬øNecesito secrets?** No, usamos `GITHUB_TOKEN` por defecto.
- **¬øPublica a npm?** No. En frontend usamos `@semantic-release/npm` solo para manejar versi√≥n/local changelog, **sin publicar**.
- **¬øPuedo cambiar los tags de im√°genes?** S√≠, ajust√° los `tags:` en los jobs de Docker en `release-*`.
- **¬øY si un servicio no debe publicar imagen?** Quitalo de la matriz de Docker o agreg√° una condici√≥n en `if:`.
ersi√≥n/local changelog, **sin publicar**.
- **¬øPuedo cambiar los tags de im√°genes?** S√≠, ajust√° los `tags:` en los jobs de Docker en `release-*`.
- **¬øY si un servicio no debe publicar imagen?** Quitalo de la matriz de Docker o agreg√° una condici√≥n en `if:`.